<script src="https://ec2-52-23-163-175.compute-1.amazonaws.com:8089/video_call/RTCMultiConnection.min.js"></script>
<script src="https://ec2-52-23-163-175.compute-1.amazonaws.com:8089/video_call/socket.io.js"></script>
<input id="videoCallButton" type="button" disabled value="Join Call"/>
<input id="endCallButton" type="button" disabled value="End Call"/>
<script>
    function getQueryParams() {
        let queryDict = {};
        location.search.substr(1).split("&").forEach(function(item) {queryDict[item.split("=")[0]] = item.split("=")[1]});
        return queryDict;
    }

    let videoCallButton = document.getElementById("videoCallButton");
    let endCallButton = document.getElementById("endCallButton");

    videoCallButton.removeAttribute("disabled");

    let queryParams = getQueryParams();
    let connection = new RTCMultiConnection();

    // this line is VERY_important
    connection.socketURL = 'https://ec2-52-23-163-175.compute-1.amazonaws.com:443/';
    connection.autoCloseEntireSession = false;

    // if you want audio+video conferencing
    connection.session = {
        audio: true,
        video: true
    };

    connection.sdpConstraints.mandatory = {
        OfferToReceiveAudio: true,
        OfferToReceiveVideo: true
    };

    let roomid = queryParams["roomId"];

    videoCallButton.addEventListener("click", function() {
        videoCallButton.setAttribute("disabled", true);
        endCallButton.removeAttribute("disabled");
        connection.openOrJoin(roomid);
    });

    endCallButton.addEventListener("click", function() {
        endCall();
        endCallButton.setAttribute("disabled", true);
        videoCallButton.removeAttribute("disabled");
    });

    connection.onleave = function(e) {
        if (e.userid === roomid) {
            endCall();

            if (confirm("Initiator ended the call. Do you wish to restart this call?") === true) {
                connection.openOrJoin(roomid);
            }
            else {
                endCallButton.setAttribute("disabled", true);
                videoCallButton.removeAttribute("disabled");
            }
        }
    };

    function endCall() {
        connection.leave();
        connection.attachStreams.forEach(function(stream) {
            stream.stop(); // optional
        });
        connection.closeSocket(); // strongly recommended
    }

</script>